import numpy as np

# EMBEDDED HISTORICAL DATA (Auto-generated from MongoDB)
# Total: 217 trading days
# Date range: 2025-01-02 to 2025-11-24

_HISTORICAL_DATES = ['2025-01-02', '2025-01-03', '2025-01-06', '2025-01-07', '2025-01-08', '2025-01-10', '2025-01-13', '2025-01-14', '2025-01-15', '2025-01-16', '2025-01-17', '2025-01-21', '2025-01-22', '2025-01-23', '2025-01-24', '2025-01-27', '2025-01-28', '2025-01-29', '2025-01-30', '2025-01-31', '2025-02-03', '2025-02-04', '2025-02-05', '2025-02-06', '2025-02-07', '2025-02-10', '2025-02-11', '2025-02-12', '2025-02-13', '2025-02-14', '2025-02-18', '2025-02-19', '2025-02-20', '2025-02-21', '2025-02-24', '2025-02-25', '2025-02-26', '2025-02-27', '2025-02-28', '2025-03-03', '2025-03-04', '2025-03-05', '2025-03-06', '2025-03-07', '2025-03-10', '2025-03-11', '2025-03-12', '2025-03-13', '2025-03-14', '2025-03-17', '2025-03-18', '2025-03-19', '2025-03-20', '2025-03-21', '2025-03-24', '2025-03-25', '2025-03-26', '2025-03-27', '2025-03-28', '2025-03-31', '2025-04-01', '2025-04-02', '2025-04-03', '2025-04-04', '2025-04-07', '2025-04-08', '2025-04-09', '2025-04-10', '2025-04-11', '2025-04-14', '2025-04-15', '2025-04-16', '2025-04-17', '2025-04-21', '2025-04-22', '2025-04-23', '2025-04-24', '2025-04-25', '2025-04-28', '2025-04-29', '2025-04-30', '2025-05-01', '2025-05-02', '2025-05-05', '2025-05-06', '2025-05-07', '2025-05-08', '2025-05-09', '2025-05-13', '2025-05-14', '2025-05-15', '2025-05-16', '2025-05-19', '2025-05-20', '2025-05-21', '2025-05-22', '2025-05-23', '2025-05-27', '2025-05-28', '2025-05-29', '2025-05-30', '2025-06-02', '2025-06-03', '2025-06-04', '2025-06-05', '2025-06-06', '2025-06-09', '2025-06-10', '2025-06-11', '2025-06-12', '2025-06-13', '2025-06-16', '2025-06-17', '2025-06-18', '2025-06-20', '2025-06-23', '2025-06-24', '2025-06-25', '2025-06-26', '2025-06-27', '2025-06-30', '2025-07-01', '2025-07-02', '2025-07-03', '2025-07-07', '2025-07-08', '2025-07-09', '2025-07-10', '2025-07-11', '2025-07-14', '2025-07-15', '2025-07-16', '2025-07-17', '2025-07-18', '2025-07-21', '2025-07-22', '2025-07-23', '2025-07-24', '2025-07-25', '2025-07-28', '2025-07-29', '2025-07-30', '2025-07-31', '2025-08-01', '2025-08-04', '2025-08-05', '2025-08-06', '2025-08-07', '2025-08-08', '2025-08-11', '2025-08-12', '2025-08-13', '2025-08-14', '2025-08-15', '2025-08-18', '2025-08-19', '2025-08-20', '2025-08-21', '2025-08-22', '2025-08-25', '2025-08-26', '2025-08-27', '2025-08-28', '2025-08-29', '2025-09-02', '2025-09-03', '2025-09-04', '2025-09-05', '2025-09-08', '2025-09-09', '2025-09-10', '2025-09-11', '2025-09-12', '2025-09-15', '2025-09-16', '2025-09-17', '2025-09-18', '2025-09-19', '2025-09-22', '2025-09-23', '2025-09-24', '2025-09-25', '2025-09-26', '2025-09-29', '2025-09-30', '2025-10-01', '2025-10-02', '2025-10-03', '2025-10-06', '2025-10-07', '2025-10-08', '2025-10-09', '2025-10-10', '2025-10-13', '2025-10-14', '2025-10-15', '2025-10-16', '2025-10-17', '2025-10-20', '2025-10-22', '2025-10-23', '2025-10-24', '2025-10-27', '2025-10-28', '2025-10-30', '2025-10-31', '2025-11-03', '2025-11-04', '2025-11-05', '2025-11-07', '2025-11-10', '2025-11-11', '2025-11-12', '2025-11-17', '2025-11-18', '2025-11-19', '2025-11-24']
_HISTORICAL_OPENS = [248.92999, 243.37, 244.33, 242.98, 241.97, 240.024994, 233.5, 234.75, 234.64, 237.49001, 232.11501, 224.0, 219.94, 224.73, 224.97501, 224.029999, 230.85, 234.14999, 238.66499, 247.039993, 229.44, 227.2, 229.39529, 231.34, 232.515, 229.57001, 228.2, 231.27499, 238.42, 241.070007, 243.91, 244.61, 244.97, 245.965, 244.808, 248.0, 244.33, 239.345, 236.95, 241.722, 237.705, 235.495, 234.435, 235.105, 235.48, 223.8, 220.17999, 215.94, 211.25, 213.36, 214.14, 214.22, 213.99001, 211.515, 221.0, 220.77, 223.50999, 221.33, 221.649, 217.22, 219.80499, 221.19, 205.52, 196.17, 177.24001, 186.73, 172.179, 189.16499, 186.17999, 211.44, 201.855, 198.36, 197.14999, 193.265, 196.070007, 206.0, 204.88499, 206.42999, 210.055, 208.69299, 209.3, 209.0099945, 206.089996, 203.125, 198.125, 199.19501, 197.74001, 199.0050049, 210.42999, 212.425, 210.995, 212.32001, 208.024994, 208.044998, 205.12, 200.715, 193.66499, 198.3, 200.67999, 203.27, 199.405, 201.625, 202.13499, 202.91, 203.595, 202.995, 204.39999, 200.60001, 203.47, 198.8988, 199.50999, 197.28999, 197.25, 195.94501, 198.235, 201.532, 202.59, 201.42, 201.42999, 201.895, 202.0099945, 206.66499, 209.080002, 212.145, 212.67999, 210.13, 209.53, 210.505, 210.565, 209.909, 209.14999, 210.28999, 210.625, 210.755, 212.050003, 213.235, 215.044998, 214.059998, 214.7, 214.029999, 214.16, 211.895, 208.38, 210.84, 204.505, 203.435, 205.60001, 218.875, 220.82001, 226.75, 228.0050049, 231.070007, 234.054993, 233.73, 231.78, 231.27499, 229.97, 226.28, 226.17, 226.405, 226.87, 228.58, 230.81, 232.56, 229.7, 237.2, 238.45, 239.99001, 239.3, 237.0, 232.024994, 226.875, 230.0, 237.0, 237.0, 238.97, 239.95, 241.175, 248.34, 256.5, 255.0, 253.0, 254.0, 254.0, 255.0, 255.25, 256.59, 254.66499, 257.94501, 256.82001, 256.53, 257.775, 254.87, 249.38, 246.61501, 249.38, 248.27, 248.020004, 255.88499, 262.79001, 259.89001, 261.19, 264.88, 269.13501, 271.98999, 276.98999, 270.42001, 268.24249, 268.59, 269.79501, 268.95001, 269.81, 275.075012, 268.72, 269.91501, 265.52499, 270.89999]
_HISTORICAL_HIGHS = [249.10001, 244.17999, 247.33, 245.55, 243.7123, 240.14999, 234.67, 236.12, 238.53999, 238.0099945, 232.28999, 224.42, 223.98, 227.029999, 225.63, 232.14999, 240.19, 239.855, 240.78999, 247.19, 231.83, 233.13, 232.67, 233.8, 234.0, 230.58501, 235.23, 236.96001, 242.3399, 245.41, 245.17999, 246.0099945, 246.78, 248.69, 248.86, 249.98, 244.98, 242.46001, 242.089996, 244.027206, 240.070007, 236.55, 237.86, 241.37, 236.16, 225.8399, 221.75, 216.8394, 213.94, 215.22, 215.14999, 218.75999, 217.4899, 218.84, 221.020996, 224.1, 225.020004, 224.99001, 223.8, 224.97, 223.49001, 225.19, 207.4899, 199.88, 194.14, 190.33501, 200.61, 194.77991, 199.53999, 212.94, 203.505, 200.7, 198.8335, 193.8, 201.55, 208.0, 208.8299, 209.42999, 211.48, 212.24001, 213.53999, 214.55, 206.99001, 204.10001, 200.649, 199.44, 200.049805, 200.5399, 213.39999, 213.94, 212.96001, 212.57001, 209.48, 208.47, 207.039993, 202.72, 197.7, 200.74001, 202.73, 203.78, 201.95, 202.13, 203.77, 206.24001, 204.75, 205.7, 206.0, 204.35001, 204.5, 199.6799, 200.37, 198.685, 198.3889, 197.57001, 201.7, 202.3, 203.44, 203.66, 202.61501, 203.22, 207.39, 210.18649, 213.34, 214.65, 216.23, 211.42999, 211.33, 213.48, 212.13, 210.91, 211.89, 212.39999, 211.8, 211.78999, 215.78, 214.645, 215.10001, 215.69, 215.24001, 214.845, 214.81, 212.39, 209.84, 213.58, 207.88, 205.34, 215.38, 220.85001, 230.99001, 229.56, 230.78, 234.99001, 235.11, 234.22141, 233.12, 232.86501, 230.46989, 226.52, 229.089996, 229.3, 229.49001, 230.89999, 233.41, 233.3613, 230.78, 238.71001, 239.8999, 241.32001, 240.14999, 238.7805, 232.34, 230.45, 234.50999, 238.19, 241.22, 240.10001, 241.2, 246.3, 256.63, 257.34, 255.37, 257.17001, 257.35999, 254.83, 255.91901, 258.79001, 258.17999, 259.23999, 259.070007, 257.39999, 258.51999, 258.0, 256.37, 249.6893, 248.845, 251.82001, 249.039993, 253.38, 264.375, 262.85001, 260.6199, 264.13, 269.079987, 269.87, 274.14001, 277.32001, 270.78, 271.48599, 271.70001, 272.29001, 273.73001, 275.845, 275.73001, 270.48999, 270.70499, 272.20999, 276.98001]
_HISTORICAL_LOWS = [241.8201, 241.89, 243.84, 241.36, 240.050003, 233.0, 229.72, 232.472, 234.42999, 228.029999, 228.48, 219.38, 219.8, 222.3, 221.41, 224.0, 230.85, 234.0099945, 237.21001, 233.44, 225.71001, 226.64999, 228.3, 230.425, 227.25999, 227.2, 228.13, 230.67999, 235.57001, 241.0, 241.84, 243.1604, 244.28999, 245.22, 244.59, 244.91, 239.13, 237.10001, 234.50999, 236.112, 234.7, 229.23, 233.33, 234.835, 224.22, 217.45, 214.91, 208.42, 209.58, 209.98, 211.49001, 213.75, 212.22, 211.47, 218.58, 220.085, 220.47, 220.5601, 217.67999, 216.24001, 218.89999, 221.050003, 201.25, 187.345, 174.62, 169.2101, 171.89, 183.0, 186.059998, 201.16209, 199.82001, 192.37, 194.42, 189.8112, 196.0, 202.799, 202.94, 206.2, 207.47, 208.37, 206.6705, 208.89999, 202.16, 198.21001, 197.020004, 193.25, 194.6796, 197.535, 209.080002, 210.58009, 209.53999, 209.77, 204.25999, 205.029999, 200.72, 199.7, 193.46001, 197.42999, 199.89999, 198.50999, 196.78, 200.12, 200.955, 202.14999, 200.15961, 202.050003, 200.020004, 200.57001, 198.41, 197.36011, 195.77, 196.5636, 195.21001, 195.070007, 196.8596, 198.96001, 200.2, 200.6201, 199.46001, 200.22, 199.2607, 206.14011, 208.14, 211.825, 208.8, 208.45, 207.22, 210.12, 209.86, 207.53999, 208.92, 208.64, 209.59, 209.7045, 211.6409, 212.2301, 212.41, 213.53, 213.39999, 213.059998, 210.825, 207.72, 207.16, 201.5, 201.675, 202.16, 205.59, 213.25, 219.25, 224.76241, 227.10001, 230.42999, 230.85001, 229.36, 230.11, 229.35001, 225.77, 223.7804, 225.41, 226.24001, 224.69, 228.295, 229.33501, 231.37, 226.97, 234.37, 236.74001, 238.4901, 236.34, 233.37, 225.95219, 226.64999, 229.020004, 235.029999, 236.3235, 237.7301, 236.64999, 240.2106, 248.17, 253.59, 251.039993, 251.71201, 253.78, 253.0099945, 253.11, 255.050003, 254.14999, 253.96001, 255.050003, 255.42999, 256.10999, 253.14, 244.7, 245.56, 244.7, 247.48, 245.13, 247.27, 255.63, 255.42999, 258.010101, 259.17999, 264.65009, 268.14999, 268.48001, 269.16, 266.25, 267.61499, 266.92999, 266.78, 267.45499, 269.79999, 271.87, 265.73001, 265.32001, 265.5, 270.89999]
_HISTORICAL_CLOSES = [243.82001, 243.3, 245.0, 242.19, 242.72, 236.92999, 234.39999, 233.28, 237.85001, 228.24001, 229.99001, 222.66, 223.77, 223.64999, 222.78999, 229.94, 238.23, 239.35001, 237.56, 235.86, 227.98, 232.78999, 232.46001, 233.22, 227.71001, 227.64, 232.77, 236.89, 241.52, 244.57001, 244.47, 244.88, 245.86, 245.59, 247.23, 247.050003, 240.31, 237.38, 241.84, 238.14, 236.070007, 235.77, 235.32001, 239.070007, 227.541, 220.73, 216.94, 209.71001, 213.38, 214.19, 212.78999, 215.3, 214.14999, 218.36, 220.42999, 223.76, 221.39999, 223.92999, 217.88, 221.995, 223.14, 223.78999, 203.059998, 188.38, 181.59, 172.77, 198.85001, 190.44, 198.020004, 202.59, 202.13, 194.3, 196.87, 193.089996, 199.66, 204.36, 208.2, 209.23, 210.1, 211.24001, 212.49001, 212.83, 205.3, 198.77, 198.41, 196.25, 197.39999, 198.53999, 212.84, 212.41, 211.45799, 211.19, 208.75999, 206.87, 202.059998, 201.37, 195.34, 200.2, 200.42, 199.95, 200.66, 201.8, 203.34, 202.88699, 200.55, 203.92999, 201.44, 202.75, 198.85001, 199.2, 196.45, 198.37, 195.64, 196.25, 200.94, 201.55, 200.28999, 201.60001, 200.94, 201.10001, 205.12, 207.86, 212.41, 213.44, 209.94, 210.035004, 211.11, 212.42, 211.074997, 208.53999, 209.0099945, 210.22, 210.061005, 211.22, 212.53999, 214.39, 214.31, 213.75999, 213.96001, 214.039993, 211.35001, 209.020004, 207.61, 202.27, 203.34, 202.92999, 213.25, 220.13, 229.37, 227.205, 229.64999, 233.33, 232.83, 231.64999, 230.88, 230.53999, 225.96001, 224.91, 227.75, 227.14999, 229.3, 230.44, 232.49001, 232.27, 229.71001, 238.49001, 239.71001, 239.67, 237.92, 234.35001, 226.78, 230.020004, 234.059998, 236.75999, 238.14, 238.97, 237.85001, 245.28999, 256.089996, 254.53, 252.24001, 256.94, 255.46001, 254.35001, 254.56, 255.41, 257.14001, 258.015015, 256.64999, 256.48999, 258.029999, 254.03, 245.31, 247.59, 247.85001, 249.42999, 247.42999, 252.3, 262.23001, 258.42999, 259.57999, 262.73999, 268.73999, 269.029999, 271.29001, 270.25, 269.059998, 270.20999, 270.10999, 268.42001, 269.35999, 275.29999, 273.47, 267.45999, 267.51001, 268.54999, 275.98001]
_HISTORICAL_VOLUMES = [48004805, 31628615, 30153543, 23097505, 25734462, 44563705, 36305622, 26892068, 26852818, 57891825, 56457594, 62318942, 46109424, 46708707, 68612711, 75151045, 2269573, 37142813, 35926233, 75254942, 59003090, 34429003, 28051511, 22264021, 31728627, 23258511, 43422340, 34050225, 37495524, 32247624, 30912048, 24788270, 24995779, 43625419, 39200212, 38308285, 35362483, 32553133, 35164606, 35053294, 42018676, 35677214, 35260019, 39727194, 59787554, 61291713, 53532974, 52229564, 48250825, 37682149, 33231133, 38729209, 34742281, 53731606, 33006370, 1556286, 26965766, 28059309, 30668590, 43725434, 27807238, 25153557, 88825781, 109772324, 142338035, 103457714, 157616504, 101458425, 73602796, 91986847, 39683999, 48833809, 41714055, 32800518, 43132388, 43636927, 32014586, 29666863, 1252949, 25849653, 30151819, 39297750, 82340780, 52796473, 40291241, 49450274, 38181272, 29372352, 41061954, 37572369, 35420540, 40829472, 36746948, 33355386, 49990060, 40611872, 70476021, 46078807, 32654129, 42922985, 43374866, 28715713, 33483966, 36114244, 39337390, 38612906, 63536479, 42508225, 52626223, 34137679, 43234353, 34126353, 31222974, 34234764, 65624950, 42897519, 46006745, 33528311, 42179808, 42917581, 70864920, 70690569, 61234132, 2277281, 41439631, 33418262, 39875818, 37227143, 27758821, 31228417, 32420832, 35525635, 40763246, 38648109, 44219721, 38937991, 37167764, 37303784, 33521925, 29032790, 37887505, 30164207, 47129922, 82968671, 56984547, 33636067, 87501851, 80742594, 103769917, 54466723, 44296395, 60796247, 42910627, 42420475, 29020390, 30245483, 32871941, 25086371, 34446170, 25711201, 28944468, 25020837, 29527590, 30010626, 31017715, 59746133, 38840492, 45106572, 39352997, 58088738, 70572077, 41749496, 48762816, 37061691, 51396681, 34698751, 33806986, 91290692, 91859612, 48883791, 33755477, 74823688, 23876498, 20028943, 24486376, 34561649, 35239524, 41998349, 33689615, 25624231, 26877955, 31168395, 60016039, 28863202, 25403943, 25088215, 33076151, 40127425, 80312282, 36338452, 23547346, 30941470, 33646441, 34286738, 30997762, 42029484, 25883711, 29588186, 45499998, 26580244, 22598083, 34817091, 33961538, 24159801, 24186259, 27145098, 31558654]

# --- Generated Algorithm Code Below ---

# Global scalping state variables
_prices = []
_entry_price = None
_entry_tick = None
_position_type = None
_trade_count = 0
_window_size = 100  # minutes

def calculate_sma(prices, period):
    """Simple Moving Average"""
    if len(prices) < period:
        return None
    return sum(prices[-period:]) / period

def calculate_ema(prices, period):
    """Exponential Moving Average"""
    if len(prices) < period:
        return None
    multiplier = 2 / (period + 1)
    ema = sum(prices[:period]) / period
    for price in prices[period:]:
        ema = (price - ema) * multiplier + ema
    return ema

def calculate_rsi(prices, period=14):
    """Relative Strength Index"""
    if len(prices) < period + 1:
        return 50
    gains, losses = [], []
    for i in range(1, len(prices)):
        change = prices[i] - prices[i-1]
        gains.append(max(0, change))
        losses.append(max(0, -change))
    avg_gain = sum(gains[-period:]) / period
    avg_loss = sum(losses[-period:]) / period
    if avg_loss == 0:
        return 100
    rs = avg_gain / avg_loss
    return 100 - (100 / (1 + rs))

def calculate_bollinger_bands(prices, period=20, std_dev=2):
    """Bollinger Bands - returns (lower, middle, upper)"""
    if len(prices) < period:
        return None, None, None
    sma = sum(prices[-period:]) / period
    variance = sum((p - sma) ** 2 for p in prices[-period:]) / period
    std = variance ** 0.5
    return sma - std_dev * std, sma, sma + std_dev * std

def execute_trade(ticker, price, tick, cash_balance, shares_held):
    global _prices, _entry_price, _entry_tick, _position_type, _trade_count
    
    _prices.append(price)
    
    # For scalping, keep a limited history of last WINDOW_SIZE minutes
    if len(_prices) > _window_size:
        _prices.pop(0)  # Remove oldest data to save memory
    
    # Skip decision-making if not enough data
    if len(_prices) < 20:  # Need 14 candles for RSI
        return "HOLD"
    
    # Stunning close: time to exit if near end of day
    if tick >= 375:
        if shares_held != 0:
            return ("BUY", abs(shares_held)) if shares_held < 0 else ("SELL", abs(shares_held))
        return "HOLD"
    
    # Handle existing position (CLOSE on stop-profit/loss/timer)
    if shares_held != 0 and _entry_price is not None:
        if shares_held > 0:  # Long position
            exit_price = _entry_price * (1 - 0.5)  # 0.5% profit target
            stop_price = _entry_price * (1 - 0.3)  # 0.3% stop loss
        else:  # Short position
            exit_price = _entry_price * (1 + 0.5)  # 0.5% profit target
            stop_price = _entry_price * (1 + 0.3)  # 0.3% stop loss

        # Time-based exit (max 20 ticks per position)
        if tick >= _entry_tick + 20:
            if shares_held > 0:
                return ("SELL", shares_held)
            else:
                return ("BUY", abs(shares_held))
        
        # Price-based exit
        if shares_held > 0 and price <= stop_price:
            _entry_price = None
            _entry_tick = None
            _position_type = None
            return ("SELL", shares_held)
        elif shares_held < 0 and price >= stop_price:
            _entry_price = None
            _entry_tick = None
            _position_type = None
            return ("BUY", abs(shares_held))
        
        # Profit-taking
        if shares_held > 0 and price >= exit_price:
            _entry_price = None
            _entry_tick = None
            _position_type = None
            _trade_count += 1
            return ("SELL", shares_held)
        elif shares_held < 0 and price <= exit_price:
            _entry_price = None
            _entry_tick = None
            _position_type = None
            _trade_count += 1
            return ("BUY", abs(shares_held))
    
    # Find Price Swing High and Low (last 100 minutes)
    recent_high = max(_prices[-100:]) if len(_prices) >= 100 else max(_prices)
    recent_low = min(_prices[-100:]) if len(_prices) >= 100 else min(_prices)

    # Calculate Bollinger Bands for dynamic levels
    low_bb, mid_bb, high_bb = calculate_bollinger_bands(_prices, 20, 2)
    
    # RSI indicator
    rsi_val = calculate_rsi(_prices, 14)
    
    # Filter for strong trend using 20/50 SMA
    sma_short = calculate_sma(_prices, 20)
    sma_long = calculate_sma(_prices, 50)
    is_up_trend = sma_short is not None and sma_long is not None and sma_short > sma_long
    
    # Scalping signals with leverage
    if shares_held == 0:  # No position - look for entries
        # Aggressive Breakout Strategy
        thresh_buy = -0.2
        thresh_sell = 0.2
        
        price_from_high = (price - recent_high) / recent_high * 100
        price_from_low = (price - recent_low) / recent_low * 100
        
        # BUY signal: Trend-follower (Uptrend preferred) + RSI bullish dip
        if (price_from_high <= thresh_buy and 
            rsi_val < 45 and 
            is_up_trend and 
            price > low_bb and 
            len(_prices) % 3 == 0):  # Strict timing
            
            _entry_price = price
            _entry_tick = tick
            _position_type = 'long'
            return ("BUY", 300)
        
        # SELL signal: Trend-follower + RSI bearish counter-trend
        if (price_from_low >= thresh_sell and 
            rsi_val > 60 and 
            not is_up_trend and 
            price < high_bb and 
            len(_prices) % 3 == 0):
            
            _entry_price = price
            _entry_tick = tick
            _position_type = 'short'
            return ("SELL", 300)
    
    return "HOLD"